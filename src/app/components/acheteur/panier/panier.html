<div class="panier-container">
  <!-- En-tête -->
  <div class="panier-header">
    <h1>Mon Panier</h1>
    <button
      *ngIf="panier && panier.nombre_articles > 0"
      class="btn-vider"
      (click)="viderPanier()"
      [disabled]="loading">
      <i class="fas fa-trash"></i> Vider le panier
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Chargement du panier...</p>
  </div>

  <!-- Panier vide -->
  <div *ngIf="!loading && (!panier || panier.nombre_articles === 0)" class="panier-vide">
    <i class="fas fa-shopping-cart fa-3x"></i>
    <h2>Votre panier est vide</h2>
    <p>Découvrez nos boutiques et trouvez vos produits préférés</p>
    <button routerLink="/boutique/all" class="btn-decouvrir">
      <i class="fas fa-store"></i> Découvrir les boutiques
    </button>
  </div>

  <!-- Panier avec articles -->
  <div *ngIf="!loading && panier && panier.nombre_articles > 0" class="panier-content">

    <!-- Articles groupés par boutique -->
    <div class="panier-articles">
      <div *ngFor="let group of itemsParBoutique | keyvalue" class="boutique-section">
        <div class="boutique-header">
          <i class="fas fa-store"></i>
          <h3>{{ group.value.boutique.nom }}</h3>
          <span class="boutique-total">{{ formatPrice(group.value.total) }}</span>
        </div>

        <div class="articles-list">
          <div *ngFor="let item of group.value.items" class="article-card">
            <!-- Image -->
            <div class="article-image">
              <img
                [src]="item.produit.images && item.produit.images.length > 0 && item.produit.images[0]
                      ? item.produit.images[0]
                      : 'https://res.cloudinary.com/dll5d7pgm/image/upload/v1771525166/boutiques/bphykymmvhbp2kzejmwb.png'"
                [alt]="item.produit.nom"
                (error)="$event.target.src = 'https://res.cloudinary.com/dll5d7pgm/image/upload/v1771525166/boutiques/bphykymmvhbp2kzejmwb.png'"
                loading="lazy"
              />
            </div>

            <!-- Infos produit -->
            <div class="article-infos">
              <h4>{{ item.produit.nom }}</h4>

              <div class="article-prix">
                <span *ngIf="item.en_promotion" class="prix-promo">
                  {{ formatPrice(item.prix_unitaire) }}
                </span>
                <span [class.prix-barre]="item.en_promotion">
                  {{ formatPrice(item.produit.prix) }}
                </span>
                <span class="prix-unite">/ pièce</span>
              </div>
              <div class="stock-info" [class.stock-faible]="item.stock_disponible <= 5">
                <i class="fas fa-box"></i>
                Stock: {{ item.stock_disponible }}
              </div>
            </div>

            <!-- Quantité et actions -->
            <div class="article-actions">
              <div class="quantite-control">
                <button
                  (click)="modifierQuantite(item.produit._id, item.quantite - 1)"
                  [disabled]="item.quantite <= 1 || isUpdating(item.produit._id)"
                  class="btn-qte">
                  <i class="fas fa-minus"></i>
                </button>

                <span class="quantite">
                  {{ isUpdating(item.produit._id) ? '...' : item.quantite }}
                </span>

                <button
                  (click)="modifierQuantite(item.produit._id, item.quantite + 1)"
                  [disabled]="item.quantite >= item.stock_disponible || isUpdating(item.produit._id)"
                  class="btn-qte">
                  <i class="fas fa-plus"></i>
                </button>
              </div>

              <div class="article-total">
                {{ formatPrice(item.prix_total) }}
              </div>

              <button
                class="btn-supprimer"
                (click)="supprimerProduit(item.produit._id)"
                [disabled]="isUpdating(item.produit._id)"
                title="Supprimer">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Résumé -->
    <div class="panier-resume">
      <div class="resume-card">
        <div class="resume-item">
          <span class="label">Sous-total</span>
          <span class="value">{{ formatPrice(panier.total_original) }}</span>
        </div>
        <div class="resume-item economies">
          <span class="label">Économies</span>
          <span class="value">- {{ formatPrice(panier.total_economies) }}</span>
        </div>
        <div class="resume-item total">
          <span class="label">Total</span>
          <span class="value">{{ formatPrice(panier.total) }}</span>
        </div>

        <!-- ✅ Bouton conditionnel avec message d'info -->
        <div *ngIf="aDesCommandesEnAttente" class="alert-attente">
          <i class="fas fa-exclamation-triangle"></i>
          <span>Vous avez des commandes en attente de paiement.</span>
        </div>

        <button
          class="btn-commander"
          (click)="validerPanier()"
          [disabled]="loading || !panier || panier.nombre_articles === 0 || aDesCommandesEnAttente || verificationCommandesEnCours"
          [title]="aDesCommandesEnAttente ? 'Veuillez payer vos commandes en attente' : ''">
          <i class="fas fa-check-circle"></i>

          <ng-container *ngIf="!loading && !verificationCommandesEnCours">
            <span *ngIf="aDesCommandesEnAttente">Commandes en attente ⚠️</span>
            <span *ngIf="!aDesCommandesEnAttente">Valider le panier</span>
          </ng-container>

          <span *ngIf="verificationCommandesEnCours">Vérification...</span>
          <span *ngIf="loading && !verificationCommandesEnCours">Validation en cours...</span>
        </button>
      </div>
    </div>

  </div>
</div>
