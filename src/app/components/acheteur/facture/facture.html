<!-- facture.html -->
<div class="factures-container">
  <!-- En-tÃªte -->
  <div class="factures-header">
    <div class="header-left">
      <h1>Mes factures</h1>
      <p class="sous-titre" *ngIf="!loading && commandes.length > 0">
        {{ commandes.length }} facture(s) trouvÃ©e(s)
      </p>
    </div>
    <div class="header-right">
      <div class="filtres-rapides">
        <button
          class="filtre-btn"
          [class.active]="filtreActuel === 'tous'"
          (click)="filtrerParStatut('tous')">
          Tous
        </button>
        <button
          class="filtre-btn"
          [class.active]="filtreActuel === 'PAYEE'"
          (click)="filtrerParStatut('PAYEE')">
          PayÃ©es
        </button>
        <button
          class="filtre-btn"
          [class.active]="filtreActuel === 'RECUPEREE'"
          (click)="filtrerParStatut('RECUPEREE')">
          RÃ©cupÃ©rÃ©es
        </button>
        <button
          class="filtre-btn"
          [class.active]="filtreActuel === 'LIVREE'"
          (click)="filtrerParStatut('LIVREE')">
          LivrÃ©es
        </button>
      </div>
    </div>
  </div>

  <!-- Ã‰tat de chargement -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Chargement de vos factures...</p>
  </div>

  <!-- Liste des factures en grille -->
  <div *ngIf="!loading && commandes.length > 0" class="factures-grid">
    <div *ngFor="let commande of commandes" class="facture-card">
      <!-- En-tÃªte de la carte -->
      <div class="card-header" [class]="getStatutClass(commande.statut)">
        <div class="statut-badge">
          <span class="statut-icon">{{ commande.statut_info?.icon || 'ğŸ“„' }}</span>
          <span class="statut-label">{{ getStatutLabel(commande.statut) }}</span>
        </div>
        <span class="facture-reference">#{{ commande._id.slice(-8).toUpperCase() }}</span>
      </div>

      <!-- Corps de la carte -->
      <div class="card-body">
        <!-- Boutique -->
        <div class="boutique-info">
          <span class="boutique-icon">ğŸª</span>
          <span class="boutique-nom">{{ commande.boutique }}</span>
        </div>

        <!-- Date -->
        <div class="date-info">
          <span class="date-icon">ğŸ“…</span>
          <span class="date">{{ commande.date | date:'dd MMM yyyy' }}</span>
        </div>

        <!-- AperÃ§u des produits -->
        <div class="produits-apercu">
          <div *ngFor="let produit of commande.apercu_produits" class="produit-item">
            <div class="produit-image" *ngIf="produit.image; else imagePlaceholder">
              <img [src]="produit.image" [alt]="produit.nom">
            </div>
            <ng-template #imagePlaceholder>
              <div class="produit-image placeholder">
                <span>ğŸ“¦</span>
              </div>
            </ng-template>
            <div class="produit-details">
              <span class="produit-nom">{{ produit.nom }}</span>
              <span class="produit-quantite">x{{ produit.quantite }}</span>
            </div>
          </div>
          <div *ngIf="commande.nombre_articles > 3" class="plus-articles">
            +{{ commande.nombre_articles - 3 }} autre(s)
          </div>
        </div>

        <!-- Montant -->
        <div class="montant-section">
          <span class="montant-label">Total</span>
          <span class="montant-valeur">{{ formatPrice(commande.montant_total) }}</span>
        </div>
      </div>

      <!-- Pied de la carte -->
      <div class="card-footer">
        <a [routerLink]="['/acheteur/commandes', commande._id]" class="btn-details">
          Voir dÃ©tails
        </a>
        <button
          class="btn-pdf"
          title="PrÃ©visualiser la facture PDF"
          (click)="ouvrirPreviewPdf(commande)"
          [disabled]="generatingPdf === commande._id">
          <span class="pdf-icon">
            <ng-container *ngIf="generatingPdf !== commande._id">ğŸ“</ng-container>
            <span *ngIf="generatingPdf === commande._id" class="mini-spinner"></span>
          </span>
          <span class="pdf-text">PDF</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Ã‰tat vide -->
  <div *ngIf="!loading && commandes.length === 0" class="empty-state">
    <div class="empty-icon">ğŸ“­</div>
    <h3>Aucune facture trouvÃ©e</h3>
    <p *ngIf="filtreActuel !== 'tous'">
      Vous n'avez pas de commandes {{ getStatutLabel(filtreActuel).toLowerCase() }} pour le moment.
    </p>
    <p *ngIf="filtreActuel === 'tous'">
      Vous n'avez pas encore de commandes payÃ©es.
    </p>
    <button routerLink="/acheteur/boutiques" class="btn-achat">
      DÃ©couvrir les boutiques
    </button>
  </div>
</div>

<!-- ============================================================ -->
<!--  MODALE DE PRÃ‰VISUALISATION PDF                              -->
<!-- ============================================================ -->
<div class="pdf-modal-overlay" *ngIf="pdfPreviewUrl" (click)="fermerPreview($event)">
  <div class="pdf-modal" (click)="$event.stopPropagation()">

    <!-- Header modale -->
    <div class="pdf-modal-header">
      <div class="pdf-modal-title">
        <span class="pdf-title-icon">ğŸ“„</span>
        <div>
          <h2>Facture #{{ commandeSelectionnee?._id?.slice(-8)?.toUpperCase() }}</h2>
          <p class="pdf-subtitle">{{ commandeSelectionnee?.boutique }} Â· {{ commandeSelectionnee?.date | date:'dd MMMM yyyy' }}</p>
        </div>
      </div>
      <div class="pdf-modal-actions">
        <button class="btn-fermer" (click)="fermerPreviewDirect()" title="Fermer">
          âœ•
        </button>
      </div>
    </div>

    <!-- Iframe de prÃ©visualisation -->
    <div class="pdf-modal-body">
      <iframe
        [src]="pdfPreviewUrl"
        class="pdf-iframe"
        frameborder="0"
        title="PrÃ©visualisation de la facture">
      </iframe>
    </div>

  </div>
</div>
