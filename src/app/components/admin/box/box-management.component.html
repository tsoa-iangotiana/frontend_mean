<!-- box-management.component.html -->
<div class="container-fluid py-4">

  <!-- Statistiques -->
  <div class="row g-4 mb-5">
    <div class="col-md-3">
      <div class="card bg-primary text-white shadow-sm h-100">
        <div class="card-body text-center">
          <i class="bi bi-box-seam fs-3 mb-2 d-block"></i>
          <h5 class="card-title">Total Box</h5>
          <h2 class="mb-0 fw-bold">{{ stats.total_box }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white shadow-sm h-100">
        <div class="card-body text-center">
          <i class="bi bi-door-open fs-3 mb-2 d-block"></i>
          <h5 class="card-title">Box Libres</h5>
          <h2 class="mb-0 fw-bold">{{ stats.box_libres }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-danger text-white shadow-sm h-100">
        <div class="card-body text-center">
          <i class="bi bi-door-closed fs-3 mb-2 d-block"></i>
          <h5 class="card-title">Box Occupés</h5>
          <h2 class="mb-0 fw-bold">{{ stats.box_occupes }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white shadow-sm h-100">
        <div class="card-body text-center">
          <i class="bi bi-currency-exchange fs-3 mb-2 d-block"></i>
          <h5 class="card-title">Loyer Moyen</h5>
          <h2 class="mb-0 fw-bold">{{ formatCurrency(stats.loyer_moyen) }}</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtres + création -->
  <div class="card mb-5 shadow-sm">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Recherche</label>
          <input type="text" class="form-control" placeholder="Numéro de box" 
                 (input)="onSearch($event)">
        </div>
        <div class="col-md-2">
          <label class="form-label">Statut</label>
          <select class="form-select" (change)="onStatusChange($event)">
            <option value="">Tous</option>
            <option value="true">Libres</option>
            <option value="false">Occupés</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Trier par</label>
          <select class="form-select" (change)="onSortChange($event)">
            <option *ngFor="let opt of sortOptions" [value]="opt.value" 
                    [selected]="opt.value === filters.tri">
              {{ opt.label }}
            </option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" (click)="showNewBoxForm = !showNewBoxForm">
            <i class="bi bi-plus-lg me-1"></i>Nouveau Box
          </button>
        </div>
      </div>

      <!-- Formulaire nouveau box -->
      <div class="mt-4" *ngIf="showNewBoxForm">
        <div class="card border-primary shadow-sm">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>Créer un nouveau box</h5>
            <button type="button" class="btn-close btn-close-white" (click)="showNewBoxForm = false"></button>
          </div>
          <div class="card-body">
            <form [formGroup]="nouveauBoxForm" (ngSubmit)="createBox()">
              <div class="row g-3">
                <div class="col-md-3">
                  <input type="text" class="form-control" placeholder="Numéro" 
                         formControlName="numero">
                  <div class="text-danger small mt-1" *ngIf="nouveauBoxForm.get('numero')?.invalid && nouveauBoxForm.get('numero')?.touched">
                    Numéro requis
                  </div>
                </div>
                <div class="col-md-3">
                  <input type="number" class="form-control" placeholder="Surface (m²)" 
                         formControlName="surface">
                  <div class="text-danger small mt-1" *ngIf="nouveauBoxForm.get('surface')?.invalid && nouveauBoxForm.get('surface')?.touched">
                    Surface valide requise
                  </div>
                </div>
                <div class="col-md-3">
                  <input type="number" class="form-control" placeholder="Loyer (FCFA)" 
                         formControlName="prix_loyer">
                  <div class="text-danger small mt-1" *ngIf="nouveauBoxForm.get('prix_loyer')?.invalid && nouveauBoxForm.get('prix_loyer')?.touched">
                    Prix valide requis
                  </div>
                </div>
                <div class="col-md-3">
                  <button type="submit" class="btn btn-success w-100 mt-4 mt-md-0" 
                          [disabled]="nouveauBoxForm.invalid || loading">
                    <i class="bi bi-check2 me-1"></i>
                    {{ loading ? 'Création...' : 'Créer' }}
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Liste des box -->
    <div class="col-lg-8" [class.col-lg-12]="!selectedBox">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Liste des Box</h5>
          <span class="badge bg-info fs-6">Total : {{ totalBox }}</span>
        </div>
        <div class="card-body p-0">
          <div *ngIf="loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 text-muted">Chargement...</p>
          </div>

          <div *ngIf="!loading" class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Numéro</th>
                  <th>Surface</th>
                  <th>Loyer</th>
                  <th>Statut</th>
                  <th>Occupant</th>
                  <th class="text-end pe-4">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let box of boxs" 
                    [class.table-primary]="selectedBox?._id === box._id"
                    style="cursor: pointer;">
                  <td (click)="selectBox(box)">
                    <strong>{{ box.numero }}</strong>
                  </td>
                  <td (click)="selectBox(box)">{{ box.surface }} m²</td>
                  <td (click)="selectBox(box)">{{ formatCurrency(box.prix_loyer) }}</td>
                  <td (click)="selectBox(box)">
                    <span [class]="getStatusBadgeClass(box.libre)">{{ getStatusText(box.libre) }}</span>
                  </td>
                  <td (click)="selectBox(box)">
                    <ng-container *ngIf="!box.libre">
                      <strong>{{ getOccupationText(box) }}</strong>
                      <small class="text-muted d-block">{{ getOccupationSince(box) }}</small>
                    </ng-container>
                    <span *ngIf="box.libre">-</span>
                  </td>
                  <td class="text-end pe-3">
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-primary" 
                              (click)="selectBox(box); $event.stopPropagation()"
                              title="Gérer">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-outline-danger" 
                              *ngIf="box.libre"
                              (click)="deleteBox(box); $event.stopPropagation()"
                              title="Supprimer">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="boxs.length === 0">
                  <td colspan="6" class="text-center py-5 text-muted">
                    <i class="bi bi-inbox fs-1 mb-2 d-block"></i>
                    Aucun box trouvé
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <nav *ngIf="totalPages > 1" class="p-3 border-top">
            <ul class="pagination pagination-sm justify-content-center mb-0">
              <li class="page-item" [class.disabled]="currentPage === 1">
                <button class="page-link" (click)="onPageChange(currentPage - 1)">Précédent</button>
              </li>
              <li class="page-item" *ngFor="let p of [].constructor(totalPages); let i = index"
                  [class.active]="currentPage === i + 1">
                <button class="page-link" (click)="onPageChange(i + 1)">{{ i + 1 }}</button>
              </li>
              <li class="page-item" [class.disabled]="currentPage === totalPages">
                <button class="page-link" (click)="onPageChange(currentPage + 1)">Suivant</button>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>

    <!-- Panneau détails -->
    <div class="col-lg-4" *ngIf="selectedBox">
      <div class="card shadow-sm sticky-top" style="top: 20px;">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>Box {{ selectedBox.numero }}</h5>
          <button class="btn-close btn-close-white" (click)="closeDetails()"></button>
        </div>

        <div class="card-body">

          <div class="list-group list-group-flush mb-4">
            <div class="list-group-item d-flex justify-content-between">
              <span>Surface</span>
              <strong>{{ selectedBox.surface }} m²</strong>
            </div>
            <div class="list-group-item d-flex justify-content-between">
              <span>Loyer</span>
              <strong>{{ formatCurrency(selectedBox.prix_loyer) }}</strong>
            </div>
            <div class="list-group-item d-flex justify-content-between">
              <span>Statut</span>
              <span [class]="getStatusBadgeClass(selectedBox.libre) + ' px-3 py-1'">
                {{ getStatusText(selectedBox.libre) }}
              </span>
            </div>
          </div>

          <ul class="nav nav-tabs nav-fill mb-4">
            <li class="nav-item">
              <button class="nav-link" 
                      [class.active]="!showHistorique"
                      (click)="showHistorique = false">
                <i class="bi bi-gear me-1"></i>Gestion
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" 
                      [class.active]="showHistorique"
                      (click)="toggleHistorique()">
                <i class="bi bi-clock-history me-1"></i>Historique
              </button>
            </li>
          </ul>

          <div>
            <!-- Gestion -->
            <div *ngIf="!showHistorique">
              <div *ngIf="selectedBox.libre">
                <h6 class="mb-3 fw-semibold"><i class="bi bi-person-plus me-2"></i>Attribuer ce box</h6>
                <form [formGroup]="attribuerForm" (ngSubmit)="attribuerBox()">
                  <div class="mb-3">
                    <label class="form-label">Boutique</label>
                    <select class="form-select" formControlName="boutiqueId">
                      <option value="">Sélectionner...</option>
                      <option *ngFor="let b of boutiquesSansBox" [value]="b._id">
                        {{ b.nom }}
                        <span *ngIf="b.responsable">- Resp: {{ b.responsable }}</span>
                      </option>
                    </select>
                  </div>
                  <div class="mb-4">
                    <label class="form-label">Date de début</label>
                    <input type="date" class="form-control" formControlName="date_debut">
                  </div>
                  <button type="submit" class="btn btn-primary w-100" 
                          [disabled]="attribuerForm.invalid || loading">
                    <i class="bi bi-check-circle me-1"></i>
                    {{ loading ? 'Attribution...' : 'Attribuer le box' }}
                  </button>
                </form>
              </div>

              <div *ngIf="!selectedBox.libre">
                <div class="alert alert-info mb-4">
                  <h6 class="alert-heading"><i class="bi bi-person-fill me-2"></i>Occupant actuel</h6>
                  <p class="mb-1 fw-bold">{{ selectedBox.occupe_par?.nom }}</p>
                  <p class="mb-0">Depuis le {{ formatDate(selectedBox.historique_actif?.depuis || '') }}</p>
                </div>

                <h6 class="mb-3 fw-semibold"><i class="bi bi-tools me-2"></i>Actions</h6>

                <div class="card mb-3 border-danger">
                  <div class="card-header bg-danger-subtle text-danger">
                    Libérer le box
                  </div>
                  <div class="card-body">
                    <form [formGroup]="libererForm" (ngSubmit)="libererBox()">
                      <div class="mb-3">
                        <label class="form-label">Date de fin</label>
                        <input type="date" class="form-control" formControlName="date_fin">
                      </div>
                      <button type="submit" class="btn btn-danger w-100" 
                              [disabled]="loading">
                        <i class="bi bi-door-open me-1"></i>Libérer
                      </button>
                    </form>
                  </div>
                </div>

                <div class="card border-warning">
                  <div class="card-header bg-warning-subtle text-warning">
                    Transférer
                  </div>
                  <div class="card-body">
                    <form [formGroup]="transfererForm" (ngSubmit)="transfererBox()">
                      <div class="mb-3">
                        <label class="form-label">Nouvelle boutique</label>
                        <select class="form-select" formControlName="nouvelleBoutiqueId">
                          <option value="">Sélectionner...</option>
                          <option *ngFor="let b of boutiquesSansBox" [value]="b._id">
                            {{ b.nom }}
                          </option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Date de transfert</label>
                        <input type="date" class="form-control" formControlName="date_transfert">
                      </div>
                      <button type="submit" class="btn btn-warning text-white w-100" 
                              [disabled]="transfererForm.invalid || loading">
                        <i class="bi bi-arrow-right-circle me-1"></i>Transférer
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <!-- Historique -->
            <div *ngIf="showHistorique">
              <div *ngIf="loadingHistorique" class="text-center py-5">
                <div class="spinner-border text-primary"></div>
              </div>

              <div *ngIf="!loadingHistorique">
                <div class="list-group" *ngFor="let hist of historiqueBox">
                  <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <h6 class="mb-0">{{ hist.boutique.nom }}</h6>
                      <span class="badge" 
                            [ngClass]="{'bg-success': !hist.date_fin, 'bg-secondary': hist.date_fin}">
                        {{ !hist.date_fin ? 'En cours' : 'Terminé' }}
                      </span>
                    </div>
                    <div class="small text-muted mb-1">
                      {{ formatDate(hist.date_debut) }}
                      <span *ngIf="hist.date_fin"> → {{ formatDate(hist.date_fin) }}</span>
                      <span *ngIf="!hist.date_fin"> → aujourd'hui</span>
                    </div>
                    <div class="small text-success fw-medium" *ngIf="hist.date_fin">
                      Durée : {{ getDureeOccupation(hist.date_debut, hist.date_fin) }}
                    </div>
                  </div>
                </div>

                <div *ngIf="historiqueBox.length === 0" class="text-center py-5 text-muted">
                  <i class="bi bi-journal-x fs-2 mb-3 d-block"></i>
                  Aucun historique pour ce box
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>